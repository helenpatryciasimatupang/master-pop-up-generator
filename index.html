<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Master Pop Up Generator FINAL</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>

<input type="file" id="file" accept=".xlsx"><br><br>
<button onclick="generate()">Generate</button>

<script>
const normalize = v => String(v ?? '').trim().toUpperCase();

function getLatLon(x,y){
  const X=Number(x), Y=Number(y);
  if(!isFinite(X)||!isFinite(Y)) return {lat:'-',lon:'-'};
  if(Math.abs(X)<=90 && Math.abs(Y)>90) return {lat:X,lon:Y};
  if(Math.abs(Y)<=90 && Math.abs(X)>90) return {lat:Y,lon:X};
  return {lat:X,lon:Y};
}

function set(ws,r,c,v){
  ws[XLSX.utils.encode_cell({r,c})]={t:'s',v:String(v)};
}

function generate(){
  const file=document.getElementById('file').files[0];
  if(!file) return alert('Upload DATABASE');

  const reader=new FileReader();
  reader.onload=e=>{
    const wb=XLSX.read(e.target.result,{type:'binary'});
    const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

    const ws={};
    ws['!ref']='A1:AZ1000';

    let rowHome=1; // BARIS 2
    let rowPole=1; // BARIS 2

    // ===== BUILD HOOK MAP =====
    const hookMap={};
    rows.forEach(r=>{
      if(String(r.FolderPath||'').includes('/HOOK')){
        hookMap[normalize(r.Name)] = getLatLon(r.X,r.Y);
      }
    });

    // ===== HOME =====
    rows.forEach(r=>{
      if(!String(r.FolderPath||'').includes('/HOME')) return;

      const hook=hookMap[normalize(r.CLAIM_HOOK)]||{lat:'-',lon:'-'};
      const home=getLatLon(r.X,r.Y);

      set(ws,rowHome,0,'-');                  // A HOMEPASS_ID
      set(ws,rowHome,3,r.JALAN||'-');         // D STREET
      set(ws,rowHome,4,r.Name||'-');          // E HOUSE
      set(ws,rowHome,13,home.lat);            // N LAT
      set(ws,rowHome,14,home.lon);            // O LON
      set(ws,rowHome,26,hook.lat);            // AA Clamp LAT
      set(ws,rowHome,27,hook.lon);            // AB Clamp LON

      rowHome++;
    });

    // ===== POLE (MULAI BARIS 2 JUGA) =====
    const poleMap={};
    rows.forEach(r=>{
      if(String(r.FolderPath||'').includes('/POLE')){
        const k=normalize(r.Name);
        if(!poleMap[k]){
          poleMap[k]={name:r.Name,coord:getLatLon(r.X,r.Y),fat:r.FAT||'-'};
        }
      }
    });

    Object.values(poleMap)
      .sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true}))
      .forEach(p=>{
        set(ws,rowPole,28,p.name);       // AC Pole ID
        set(ws,rowPole,29,p.coord.lat); // AD Lat
        set(ws,rowPole,30,p.coord.lon); // AE Lon
        set(ws,rowPole,31,'LN (Existing)');
        set(ws,rowPole,32,'Pole 7/250');
        set(ws,rowPole,34,p.fat||'-');  // AI FAT

        rowPole++;
      });

    const outWB=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(outWB,ws,'MASTER_POP_UP');
    XLSX.writeFile(outWB,'MASTER_POP_UP.xlsx');
  };
  reader.readAsBinaryString(file);
}
</script>
</body>
</html>
