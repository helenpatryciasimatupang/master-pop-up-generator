<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Master Pop Up Generator (FINAL)</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
body { font-family: Arial, sans-serif; padding:20px }
input { display:block; margin:6px 0; padding:6px; width:380px }
button { margin-top:10px; padding:10px 24px }
</style>
</head>
<body>

<h2>Master Pop Up Generator (FINAL)</h2>

<input type="file" id="dbFile" accept=".xlsx">
<input type="file" id="kmzFile" accept=".kmz">

<h3>Input Area</h3>
<input id="area" placeholder="Nama Area">
<input id="district" placeholder="District">
<input id="subdistrict" placeholder="Sub District">
<input id="postcode" placeholder="Post Code">
<input id="fdt" placeholder="FDT Code">
<input id="idarea" placeholder="ID Area">

<button onclick="generate()">Generate Master Pop Up</button>

<script>
// ================= UTIL =================
const normalize = v => String(v ?? '').trim().toUpperCase();

function getLatLon(x,y){
  const X=Number(x), Y=Number(y);
  if(!isFinite(X)||!isFinite(Y)) return {lat:'',lon:''};
  if(Math.abs(X)<=90&&Math.abs(Y)>90) return {lat:X,lon:Y};
  if(Math.abs(Y)<=90&&Math.abs(X)>90) return {lat:Y,lon:X};
  return {lat:X,lon:Y};
}

function coordKey(lat,lon,d=6){
  if(!isFinite(lat)||!isFinite(lon)) return '';
  return `${lat.toFixed(d)},${lon.toFixed(d)}`;
}

function setCell(ws,r,c,v){
  ws[XLSX.utils.encode_cell({r,c})]={t:'s',v:String(v ?? '')};
}

// ================= LINE FILTER =================
function filterOnlyLine(text){
  if(!text) return '';
  const out=text.split(',')
    .map(s=>s.trim().toUpperCase())
    .filter(s=>/^LINE\s+[A-Z0-9]+$/.test(s));
  return out.join(',');
}

// ================= HEADER =================
const HEADERS=[
'HOMEPASS_ID','CLUSTER_NAME','PREFIX_ADDRESS','STREET_NAME','HOUSE_NUMBER','BLOCK',
'FLOOR','RT','RW','DISTRICT','SUB_DISTRICT','FDT_CODE','FAT_CODE',
'BUILDING_LATITUDE','BUILDING_LONGITUDE','Category BizPass','POST CODE',
'ADDRESS POLE / FAT','OV_UG','HOUSE_COMMENT_','BUILDING_NAME','TOWER','APTN',
'FIBER_NODE__HFC_','ID_Area','Clamp_Hook_ID','DEPLOYMENT_TYPE','NEED_SURVEY',
'Pole ID (New)','Coordinate (Lat) NEW','Coordinate (Long) NEW',
'Pole Provider (New)','Pole Type','LINE','FAT ID/NETWORK ID',
'Clamp_Hook_LATITUDE','Clamp_Hook_LONGITUDE'
];

function writeHeader(ws){
  HEADERS.forEach((h,i)=>setCell(ws,0,i,h));
  ws['!ref']='A1:AK5000';
}

// ================= GEO =================
const M_LAT=111320;
const mLon=lat=>111320*Math.cos(lat*Math.PI/180);
function distPointSeg(p,a,b){
  const px=p.lon*mLon(p.lat), py=p.lat*M_LAT;
  const ax=a.lon*mLon(a.lat), ay=a.lat*M_LAT;
  const bx=b.lon*mLon(b.lat), by=b.lat*M_LAT;
  const vx=bx-ax, vy=by-ay, wx=px-ax, wy=py-ay;
  const c1=vx*wx+vy*wy;
  if(c1<=0) return Math.hypot(px-ax,py-ay);
  const c2=vx*vx+vy*vy;
  if(c2<=c1) return Math.hypot(px-bx,py-by);
  const t=c1/c2;
  return Math.hypot(px-(ax+t*vx),py-(ay+t*vy));
}

// ================= KMZ =================
async function parseKMZ(file){
  const zip=await JSZip.loadAsync(file);
  const kml=zip.file(/\.kml$/i)[0];
  const txt=await kml.async('text');
  const xml=new DOMParser().parseFromString(txt,'text/xml');
  const segs=[];
  [...xml.getElementsByTagName('Placemark')].forEach(p=>{
    const name=p.getElementsByTagName('name')[0]?.textContent?.trim();
    const c=p.getElementsByTagName('coordinates')[0]?.textContent;
    if(!name||!c) return;
    const pts=c.trim().split(/\s+/).map(s=>{
      const [lon,lat]=s.split(',').map(Number);
      return isFinite(lat)&&isFinite(lon)?{lat,lon}:null;
    }).filter(Boolean);
    for(let i=0;i<pts.length-1;i++) segs.push({name,a:pts[i],b:pts[i+1]});
  });
  return segs;
}

// ================= MAIN =================
async function generate(){
  const db=dbFile.files[0];
  if(!db) return alert('Upload DATABASE');
  const kmz=kmzFile.files[0];

  const A={area:area.value,district:district.value,subdistrict:subdistrict.value,postcode:postcode.value,fdt:fdt.value,idarea:idarea.value};

  const fr=new FileReader();
  fr.onload=async e=>{
    const wb=XLSX.read(e.target.result,{type:'binary'});
    const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    const ws={}; writeHeader(ws);

    let rHome=1, rPole=1;

    // HOOK MAP
    const hookMap={};
    rows.forEach(r=>{
      if(String(r.FolderPath||'').toUpperCase().includes('/HOOK'))
        hookMap[normalize(r.Name)]=getLatLon(r.X,r.Y);
    });

    // NETWORK BY COORD (FAT/FDT)
    const netByCoord={};
    rows.forEach(r=>{
      const fp=String(r.FolderPath||'').toUpperCase();
      if(!fp.includes('/FAT')&&!fp.includes('/FDT')) return;
      const c=getLatLon(r.X,r.Y);
      const k=coordKey(c.lat,c.lon);
      if(!k) return;
      netByCoord[k]=r.Name;
    });

    const segs=kmz?await parseKMZ(kmz):[];
    const TOL=1.5;

    // ===== HOME =====
    rows.forEach(r=>{
      const fp=String(r.FolderPath||'');
      if(!fp.includes('/HOME')&&!fp.includes('/HOME-BIZ')) return;

      const raw=String(r.Name||'').trim();
      let block='-', house=raw;
      const m=raw.match(/^([A-Za-z])(\d+)$/);
      if(m){ block=m[1]; house=m[2].padStart(2,'0'); }

      const c=getLatLon(r.X,r.Y);
      const h=hookMap[normalize(r.CLAIM_HOOK)]||{lat:'',lon:''};

      setCell(ws,rHome,0,'-');
      setCell(ws,rHome,1,A.area);
      setCell(ws,rHome,2,'JL.');
      setCell(ws,rHome,3,r.JALAN||'-');
      setCell(ws,rHome,4,house);
      setCell(ws,rHome,5,block);
      setCell(ws,rHome,6,'-'); setCell(ws,rHome,7,'-'); setCell(ws,rHome,8,'-');
      setCell(ws,rHome,9,A.district);
      setCell(ws,rHome,10,A.subdistrict);
      setCell(ws,rHome,11,A.fdt);
      setCell(ws,rHome,12,r.FAT||'-');
      setCell(ws,rHome,13,c.lat);
      setCell(ws,rHome,14,c.lon);
      setCell(ws,rHome,15,'');
      setCell(ws,rHome,16,A.postcode);
      setCell(ws,rHome,17,'-');
      setCell(ws,rHome,18,'O');
      setCell(ws,rHome,19,'NEED SURVEY');
      setCell(ws,rHome,20,'-'); setCell(ws,rHome,21,'-'); setCell(ws,rHome,22,'-'); setCell(ws,rHome,23,'-');
      setCell(ws,rHome,24,A.idarea);
      setCell(ws,rHome,25,r.CLAIM_HOOK||'-');
      setCell(ws,rHome,26,'FAT EXT');
      setCell(ws,rHome,27,'YES');
      setCell(ws,rHome,35,h.lat);
      setCell(ws,rHome,36,h.lon);
      rHome++;
    });

    // ===== POLE =====
    const poleMap={};
    rows.forEach(r=>{
      if(String(r.FolderPath||'').toUpperCase().includes('/POLE')){
        if(!poleMap[r.Name]) poleMap[r.Name]={name:r.Name,coord:getLatLon(r.X,r.Y)};
      }
    });

    Object.values(poleMap)
      .sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true}))
      .forEach(p=>{
        let found=new Set();
        segs.forEach(s=>{
          if(distPointSeg(p.coord,s.a,s.b)<=TOL) found.add(s.name);
        });
        const line=filterOnlyLine([...found].join(','));
        const k=coordKey(p.coord.lat,p.coord.lon);
        const net=k&&netByCoord[k]?netByCoord[k]:'-';

        setCell(ws,rPole,28,p.name);
        setCell(ws,rPole,29,p.coord.lat);
        setCell(ws,rPole,30,p.coord.lon);
        setCell(ws,rPole,31,'LN (Existing)');
        setCell(ws,rPole,32,'Pole 7/250');
        setCell(ws,rPole,33,line);
        setCell(ws,rPole,34,net);
        rPole++;
      });

    const out=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(out,ws,'MASTER_POP_UP');
    XLSX.writeFile(out,'MASTER_POP_UP.xlsx');
  };
  fr.readAsBinaryString(db);
}
</script>

</body>
</html>
