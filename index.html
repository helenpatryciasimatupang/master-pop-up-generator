<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Master Pop Up Generator (FINAL â€“ TEMPLATE SAFE)</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
body { font-family: Arial, sans-serif; padding:20px }
input { display:block; margin:6px 0; padding:6px; width:380px }
button { margin-top:10px; padding:10px 24px }
</style>
</head>
<body>

<h2>Master Pop Up Generator (FINAL)</h2>

<input type="file" id="dbFile" accept=".xlsx">
<input type="file" id="kmzFile" accept=".kmz">
<input type="file" id="tplFile" accept=".xlsx">

<h3>Input Area</h3>
<input id="area" placeholder="Nama Area">
<input id="district" placeholder="District">
<input id="subdistrict" placeholder="Sub District">
<input id="postcode" placeholder="Post Code">
<input id="fdt" placeholder="FDT Code">
<input id="idarea" placeholder="ID Area">

<button onclick="generate()">Generate Master Pop Up</button>

<script>
const normalize = v => String(v ?? '').trim().toUpperCase();

function getLatLon(x,y){
  const X=Number(x), Y=Number(y);
  if(!isFinite(X)||!isFinite(Y)) return {lat:'',lon:''};
  if(Math.abs(X)<=90&&Math.abs(Y)>90) return {lat:X,lon:Y};
  if(Math.abs(Y)<=90&&Math.abs(X)>90) return {lat:Y,lon:X};
  return {lat:X,lon:Y};
}

function set(ws,r,c,v){
  ws[XLSX.utils.encode_cell({r,c})] = { t:'s', v:String(v ?? '') };
}

async function generate(){
  const db=dbFile.files[0];
  const tpl=tplFile.files[0];
  if(!db||!tpl) return alert('Upload DATABASE & TEMPLATE');

  const A={
    area:area.value,
    district:district.value,
    subdistrict:subdistrict.value,
    postcode:postcode.value,
    fdt:fdt.value,
    idarea:idarea.value
  };

  const dbWB = XLSX.read(await db.arrayBuffer());
  const rows = XLSX.utils.sheet_to_json(dbWB.Sheets[dbWB.SheetNames[0]]);

  const tplWB = XLSX.read(await tpl.arrayBuffer());
  const ws = tplWB.Sheets['MASTER_POP_UP'];
  if(!ws) return alert('Sheet MASTER_POP_UP tidak ditemukan');

  let r = 1; // ROW 2

  // HOOK MAP
  const hookMap={};
  rows.forEach(x=>{
    if(String(x.FolderPath||'').toUpperCase().includes('/HOOK'))
      hookMap[normalize(x.Name)] = getLatLon(x.X,x.Y);
  });

  // HOME
  rows.forEach(x=>{
    const fp=String(x.FolderPath||'');
    if(!fp.includes('/HOME')&&!fp.includes('/HOME-BIZ')) return;

    let raw=String(x.Name||'');
    let block='-', house=raw;
    const m=raw.match(/^([A-Za-z])(\d+)$/);
    if(m){ block=m[1]; house=m[2].padStart(2,'0'); }

    const c=getLatLon(x.X,x.Y);
    const h=hookMap[normalize(x.CLAIM_HOOK)]||{lat:'',lon:''};

    set(ws,r,1,'-');              // HOMEPASS_ID
    set(ws,r,2,A.area);
    set(ws,r,3,'JL.');
    set(ws,r,4,x.JALAN||'');
    set(ws,r,5,house);
    set(ws,r,6,block);
    set(ws,r,7,'-');
    set(ws,r,8,'-');
    set(ws,r,9,'-');
    set(ws,r,10,A.district);
    set(ws,r,11,A.subdistrict);
    set(ws,r,12,A.fdt);
    set(ws,r,13,x.FAT||'-');
    set(ws,r,14,c.lat);
    set(ws,r,15,c.lon);
    set(ws,r,18,'-');
    set(ws,r,19,'O');
    set(ws,r,20,'NEED SURVEY');
    set(ws,r,24,A.idarea);
    set(ws,r,25,x.CLAIM_HOOK||'-');
    set(ws,r,26,'FAT EXT');
    set(ws,r,27,'YES');
    set(ws,r,35,h.lat);
    set(ws,r,36,h.lon);

    r++;
  });

  XLSX.writeFile(tplWB,'MASTER_POP_UP_RESULT.xlsx');
}
</script>

</body>
</html>
