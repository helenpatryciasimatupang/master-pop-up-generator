<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Master Pop Up Generator (Template)</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input { display: block; margin: 6px 0; padding: 6px; width: 320px; }
    button { margin-top: 12px; padding: 10px 20px; }
  </style>
</head>
<body>

<h2>Master Pop Up Generator (Template Based)</h2>

<h3>Upload File</h3>
<input type="file" id="dbFile" accept=".xlsx">
<input type="file" id="templateFile" accept=".xlsx">

<h3>Input Area</h3>
<input id="area" placeholder="Nama Area">
<input id="district" placeholder="District">
<input id="subdistrict" placeholder="Sub District">
<input id="postcode" placeholder="Post Code">
<input id="fdt" placeholder="FDT Code">
<input id="idarea" placeholder="ID Area">

<button onclick="generate()">Generate Master Pop Up</button>

<script>
// ================= UTIL =================
function normalize(v) {
  return String(v ?? '').trim().toUpperCase();
}

function getLatLon(x, y) {
  const X = Number(x), Y = Number(y);
  if (!Number.isFinite(X) || !Number.isFinite(Y)) return { lat: '', lon: '' };
  if (Math.abs(X) <= 90 && Math.abs(Y) > 90) return { lat: X, lon: Y };
  if (Math.abs(Y) <= 90 && Math.abs(X) > 90) return { lat: Y, lon: X };
  return { lat: X, lon: Y };
}

function getArea() {
  return {
    area: document.getElementById('area').value,
    district: document.getElementById('district').value,
    subdistrict: document.getElementById('subdistrict').value,
    postcode: document.getElementById('postcode').value,
    fdt: document.getElementById('fdt').value,
    idarea: document.getElementById('idarea').value
  };
}

// ================= MAIN =================
function generate() {
  const dbFile = document.getElementById('dbFile').files[0];
  const tplFile = document.getElementById('templateFile').files[0];
  if (!dbFile || !tplFile) return alert('Upload DATA BASE & TEMPLATE');

  const area = getArea();

  const dbReader = new FileReader();
  const tplReader = new FileReader();

  dbReader.onload = (e1) => {
    const dbWB = XLSX.read(e1.target.result, { type: 'binary' });
    const dbSheet = dbWB.Sheets[dbWB.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(dbSheet);

    // === HOOK MAP (Name = ID HOOK) ===
    const hookMap = {};
    rows.forEach(r => {
      if (String(r.FolderPath || '').toUpperCase().includes('/HOOK')) {
        const key = normalize(r.Name);
        const coord = getLatLon(r.X, r.Y);
        if (key && !hookMap[key]) hookMap[key] = coord;
      }
    });

    // === POLE ===
    const poles = rows.filter(r =>
      String(r.FolderPath || '').toUpperCase().includes('/POLE')
    );

    tplReader.onload = (e2) => {
      const tplWB = XLSX.read(e2.target.result, { type: 'binary' });
      const sheetName = 'MASTER_POP_UP';
      const sheet = tplWB.Sheets[sheetName];

      let rowIndex = 1; // ROW 2 (0-based)

      rows.forEach(r => {
        const fp = String(r.FolderPath || '');
        if (!fp.includes('/HOME') && !fp.includes('/HOME-BIZ')) return;

        const homeCoord = getLatLon(r.X, r.Y);
        const hookCoord = hookMap[normalize(r.CLAIM_HOOK)] || { lat: '', lon: '' };
        const pole = poles.find(p => p.FAT === r.FAT);
        const poleCoord = pole ? getLatLon(pole.X, pole.Y) : { lat: '', lon: '' };

        const rowData = [
          '-',                    // HOMEPASS_ID
          area.area,              // CLUSTER_NAME
          'JL.',                  // PREFIX_ADDRESS
          r.JALAN || '',          // STREET_NAME
          r.Name || '',           // HOUSE_NUMBER
          '',                     // BLOCK
          r.Name || '',           // STREET_NUMBER
          '-', '-', '-',           // FLOOR, RT, RW
          area.district,
          area.subdistrict,
          area.postcode,
          area.fdt,
          r.FAT || '',
          homeCoord.lat,
          homeCoord.lon,
          '-',                    // ADDRESS_POLE_FAT
          'O',
          'NEED SURVEY',
          '-', '-', '-', '-',      // BUILDING_NAME, TOWER, APTN, FIBER
          area.idarea,
          r.CLAIM_HOOK || '',
          'FAT EXT',
          'YES',
          pole ? pole.Name : '',
          poleCoord.lat,
          poleCoord.lon,
          'LN (Existing)',
          'Pole 7/250',
          '',
          pole ? pole.FAT : '',
          hookCoord.lat,
          hookCoord.lon
        ];

        XLSX.utils.sheet_add_aoa(sheet, [rowData], { origin: `A${rowIndex + 1}` });
        rowIndex++;
      });

      XLSX.writeFile(tplWB, 'MASTER_POP_UP_RESULT.xlsx');
    };

    tplReader.readAsBinaryString(tplFile);
  };

  dbReader.readAsBinaryString(dbFile);
}
</script>

</body>
</html>
