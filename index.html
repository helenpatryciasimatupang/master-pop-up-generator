<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Master Pop Up Generator (Template Based)</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input { display: block; margin: 6px 0; padding: 6px; width: 340px; }
    button { margin-top: 12px; padding: 10px 22px; }
  </style>
</head>
<body>

<h2>Master Pop Up Generator</h2>

<label><b>DATA BASE.xlsx</b></label>
<input type="file" id="dbFile" accept=".xlsx">

<label><b>Template Master Pop Up.xlsx</b></label>
<input type="file" id="tplFile" accept=".xlsx">

<h3>Input Area</h3>
<input id="area" placeholder="Nama Area">
<input id="district" placeholder="District">
<input id="subdistrict" placeholder="Sub District">
<input id="postcode" placeholder="Post Code">
<input id="fdt" placeholder="FDT Code">
<input id="idarea" placeholder="ID Area">

<button onclick="generate()">Generate Master Pop Up</button>

<script>
function generate() {
  const dbFile = document.getElementById('dbFile').files[0];
  const tplFile = document.getElementById('tplFile').files[0];

  if (!dbFile || !tplFile) {
    alert('Upload DATA BASE dan Template Master Pop Up');
    return;
  }

  const dbReader = new FileReader();
  const tplReader = new FileReader();

  dbReader.onload = (dbEvt) => {
    const wbDB = XLSX.read(dbEvt.target.result, { type: 'binary' });
    const dbSheet = wbDB.Sheets[wbDB.SheetNames[0]];
    const dbRows = XLSX.utils.sheet_to_json(dbSheet);

    tplReader.onload = (tplEvt) => {
      const wbTpl = XLSX.read(tplEvt.target.result, { type: 'binary' });
      const ws = wbTpl.Sheets['MASTER_POP_UP'] || wbTpl.Sheets[wbTpl.SheetNames[0]];

      // MAP HEADER â†’ COLUMN
      const headerMap = {};
      Object.keys(ws)
        .filter(k => k.endsWith('1'))
        .forEach(k => {
          headerMap[ws[k].v] = k.replace('1', '');
        });

      const poles = dbRows.filter(r => r.FolderPath?.includes('/POLE/'));
      const hooks = dbRows.filter(r => r.FolderPath?.includes('/HOOK/'));

      let row = 2;

      dbRows.forEach(r => {
        if (!r.FolderPath) return;
        if (!r.FolderPath.includes('/HOME') && !r.FolderPath.includes('/HOME-BIZ')) return;

        const pole = poles.find(p => p.FAT === r.FAT);
        const hook = hooks.find(h => h.Name === r.CLAIM_HOOK);

        // ðŸ”’ KUNCI: LAT = X, LON = Y
        ws[headerMap['HOMEPASS_ID'] + row] = { v: '-' };
        ws[headerMap['CLUSTER_NAME'] + row] = { v: area.value };
        ws[headerMap['PREFIX_ADDRESS'] + row] = { v: 'JL.' };
        ws[headerMap['STREET_NAME'] + row] = { v: r.JALAN };
        ws[headerMap['HOUSE_NUMBER'] + row] = { v: r.Name };

        ws[headerMap['DISTRICT'] + row] = { v: district.value };
        ws[headerMap['SUB_DISTRICT'] + row] = { v: subdistrict.value };
        ws[headerMap['POST_CODE'] + row] = { v: postcode.value };
        ws[headerMap['FDT_CODE'] + row] = { v: fdt.value };

        ws[headerMap['FAT_CODE'] + row] = { v: r.FAT };
        ws[headerMap['BUILDING_LATITUDE'] + row] = { v: r.X };
        ws[headerMap['BUILDING_LONGITUDE'] + row] = { v: r.Y };

        ws[headerMap['OV_UG'] + row] = { v: 'O' };
        ws[headerMap['HOUSE_COMMENT_'] + row] = { v: 'NEED SURVEY' };
        ws[headerMap['ID_AREA'] + row] = { v: idarea.value };

        ws[headerMap['Clamp_Hook_ID'] + row] = { v: r.CLAIM_HOOK };
        ws[headerMap['DEPLOYMENT_TYPE'] + row] = { v: 'FAT EXT' };
        ws[headerMap['NEED_SURVEY'] + row] = { v: 'YES' };

        if (pole) {
          ws[headerMap['Pole ID (New)'] + row] = { v: pole.Name };
          ws[headerMap['Coordinate (Lat) NEW'] + row] = { v: pole.X };
          ws[headerMap['Coordinate (Long) NEW'] + row] = { v: pole.Y };
          ws[headerMap['FAT ID/NETWORK ID'] + row] = { v: pole.FAT };
        }

        if (hook) {
          ws[headerMap['Clamp_Hook_LATITUDE'] + row] = { v: hook.X };
          ws[headerMap['Clamp_Hook_LONGITUDE'] + row] = { v: hook.Y };
        }

        row++;
      });

      XLSX.writeFile(wbTpl, 'MASTER_POP_UP.xlsx');
    };

    tplReader.readAsBinaryString(tplFile);
  };

  dbReader.readAsBinaryString(dbFile);
}
</script>

</body>
</html>
