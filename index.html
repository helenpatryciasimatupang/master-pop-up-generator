<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Master Pop Up Generator (FINAL – TEMPLATE)</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
body { font-family: Arial, sans-serif; padding:20px }
input { display:block; margin:6px 0; padding:6px; width:380px }
button { margin-top:10px; padding:10px 24px }
</style>
</head>
<body>

<h2>Master Pop Up Generator (FINAL – TEMPLATE)</h2>

<h3>Upload File</h3>
<input type="file" id="dbFile" accept=".xlsx">
<input type="file" id="kmzFile" accept=".kmz">
<input type="file" id="templateFile" accept=".xlsx">

<h3>Input Area</h3>
<input id="area" placeholder="Nama Area">
<input id="district" placeholder="District">
<input id="subdistrict" placeholder="Sub District">
<input id="postcode" placeholder="Post Code">
<input id="fdt" placeholder="FDT Code">
<input id="idarea" placeholder="ID Area">

<button onclick="generate()">Generate Master Pop Up</button>

<script>
// ================= UTIL =================
const normalize = v => String(v ?? '').trim().toUpperCase();

function getLatLon(x,y){
  const X=Number(x), Y=Number(y);
  if(!isFinite(X)||!isFinite(Y)) return {lat:'',lon:''};
  if(Math.abs(X)<=90&&Math.abs(Y)>90) return {lat:X,lon:Y};
  if(Math.abs(Y)<=90&&Math.abs(X)>90) return {lat:Y,lon:X};
  return {lat:X,lon:Y};
}

function coordKey(lat,lon,d=6){
  if(!isFinite(lat)||!isFinite(lon)) return '';
  return `${lat.toFixed(d)},${lon.toFixed(d)}`;
}

function filterOnlyLine(text){
  if(!text) return '';
  return text.split(',')
    .map(s=>s.trim().toUpperCase())
    .filter(s=>/^LINE\s+[A-Z0-9]+$/.test(s))
    .join(',');
}

// ===== HEADER MAP (dari template) =====
function getHeaderMap(ws){
  const range = XLSX.utils.decode_range(ws['!ref']);
  const map = {};
  for(let c=range.s.c; c<=range.e.c; c++){
    const cell = ws[XLSX.utils.encode_cell({r:0,c})];
    if(cell?.v) map[cell.v.trim()] = c;
  }
  return map;
}

function setByHeader(ws,header,row,name,value){
  const c = header[name];
  if(c === undefined) return;
  ws[XLSX.utils.encode_cell({r:row,c})] = { t:'s', v:String(value ?? '') };
}

// ================= KMZ =================
async function parseKMZ(file){
  const zip = await JSZip.loadAsync(file);
  const kml = zip.file(/\.kml$/i)[0];
  const text = await kml.async('text');
  const xml = new DOMParser().parseFromString(text,'text/xml');
  const segs=[];
  [...xml.getElementsByTagName('Placemark')].forEach(p=>{
    const name=p.getElementsByTagName('name')[0]?.textContent?.trim();
    const c=p.getElementsByTagName('coordinates')[0]?.textContent;
    if(!name||!c) return;
    const pts=c.trim().split(/\s+/).map(s=>{
      const [lon,lat]=s.split(',').map(Number);
      return isFinite(lat)&&isFinite(lon)?{lat,lon}:null;
    }).filter(Boolean);
    for(let i=0;i<pts.length-1;i++) segs.push({name,a:pts[i],b:pts[i+1]});
  });
  return segs;
}

// ================= MAIN =================
async function generate(){
  const db=dbFile.files[0];
  const tpl=templateFile.files[0];
  if(!db||!tpl) return alert('Upload DATABASE & TEMPLATE');
  const kmz=kmzFile.files[0];

  const A={area:area.value,district:district.value,subdistrict:subdistrict.value,postcode:postcode.value,fdt:fdt.value,idarea:idarea.value};

  const dbReader=new FileReader();
  const tplReader=new FileReader();

  dbReader.onload=async e1=>{
    const dbWB=XLSX.read(e1.target.result,{type:'binary'});
    const rows=XLSX.utils.sheet_to_json(dbWB.Sheets[dbWB.SheetNames[0]]);

    tplReader.onload=async e2=>{
      const tplWB=XLSX.read(e2.target.result,{type:'binary'});
      const ws=tplWB.Sheets['MASTER_POP_UP'];
      if(!ws) return alert('Sheet MASTER_POP_UP tidak ditemukan');

      const H=getHeaderMap(ws);
      let rowHome=1, rowPole=1;

      // ===== HOOK MAP =====
      const hookMap={};
      rows.forEach(r=>{
        if(String(r.FolderPath||'').toUpperCase().includes('/HOOK'))
          hookMap[normalize(r.Name)]=getLatLon(r.X,r.Y);
      });

      // ===== FAT/FDT by coord =====
      const netByCoord={};
      rows.forEach(r=>{
        const fp=String(r.FolderPath||'').toUpperCase();
        if(!fp.includes('/FAT')&&!fp.includes('/FDT')) return;
        const c=getLatLon(r.X,r.Y);
        const k=coordKey(c.lat,c.lon);
        if(k) netByCoord[k]=r.Name;
      });

      const segs=kmz?await parseKMZ(kmz):[];
      const TOL=1.5;

      // ===== HOME =====
      rows.forEach(r=>{
        const fp=String(r.FolderPath||'');
        if(!fp.includes('/HOME')&&!fp.includes('/HOME-BIZ')) return;

        const raw=String(r.Name||'').trim();
        let block='-', house=raw;
        const m=raw.match(/^([A-Za-z])(\d+)$/);
        if(m){ block=m[1]; house=m[2].padStart(2,'0'); }

        const c=getLatLon(r.X,r.Y);
        const h=hookMap[normalize(r.CLAIM_HOOK)]||{lat:'',lon:''};

        setByHeader(ws,H,rowHome,'HOMEPASS_ID','-');
        setByHeader(ws,H,rowHome,'CLUSTER_NAME',A.area);
        setByHeader(ws,H,rowHome,'PREFIX_ADDRESS','JL.');
        setByHeader(ws,H,rowHome,'STREET_NAME',r.JALAN||'-');
        setByHeader(ws,H,rowHome,'HOUSE_NUMBER',house);
        setByHeader(ws,H,rowHome,'BLOCK',block);
        setByHeader(ws,H,rowHome,'FLOOR','-');
        setByHeader(ws,H,rowHome,'RT','-');
        setByHeader(ws,H,rowHome,'RW','-');
        setByHeader(ws,H,rowHome,'DISTRICT',A.district);
        setByHeader(ws,H,rowHome,'SUB_DISTRICT',A.subdistrict);
        setByHeader(ws,H,rowHome,'FDT_CODE',A.fdt);
        setByHeader(ws,H,rowHome,'FAT_CODE',r.FAT||'-');
        setByHeader(ws,H,rowHome,'BUILDING_LATITUDE',c.lat);
        setByHeader(ws,H,rowHome,'BUILDING_LONGITUDE',c.lon);
        setByHeader(ws,H,rowHome,'POST CODE',A.postcode);
        setByHeader(ws,H,rowHome,'ADDRESS POLE / FAT','-');
        setByHeader(ws,H,rowHome,'OV_UG','O');
        setByHeader(ws,H,rowHome,'HOUSE_COMMENT_','NEED SURVEY');
        setByHeader(ws,H,rowHome,'BUILDING_NAME','-');
        setByHeader(ws,H,rowHome,'TOWER','-');
        setByHeader(ws,H,rowHome,'APTN','-');
        setByHeader(ws,H,rowHome,'FIBER_NODE__HFC_','-');
        setByHeader(ws,H,rowHome,'ID_Area',A.idarea);
        setByHeader(ws,H,rowHome,'Clamp_Hook_ID',r.CLAIM_HOOK||'-');
        setByHeader(ws,H,rowHome,'DEPLOYMENT_TYPE','FAT EXT');
        setByHeader(ws,H,rowHome,'NEED_SURVEY','YES');
        setByHeader(ws,H,rowHome,'Clamp_Hook_LATITUDE',h.lat);
        setByHeader(ws,H,rowHome,'Clamp_Hook_LONGITUDE',h.lon);

        rowHome++;
      });

      // ===== POLE =====
      const poleMap={};
      rows.forEach(r=>{
        if(String(r.FolderPath||'').toUpperCase().includes('/POLE')){
          if(!poleMap[r.Name]) poleMap[r.Name]={name:r.Name,coord:getLatLon(r.X,r.Y)};
        }
      });

      Object.values(poleMap)
        .sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true}))
        .forEach(p=>{
          let found=new Set();
          segs.forEach(s=>{
            if(Math.hypot(p.coord.lat-s.a.lat,p.coord.lon-s.a.lon)<=0.00002) found.add(s.name);
          });

          const line=filterOnlyLine([...found].join(','));
          const k=coordKey(p.coord.lat,p.coord.lon);
          const net=k&&netByCoord[k]?netByCoord[k]:'-';

          setByHeader(ws,H,rowPole,'Pole ID (New)',p.name);
          setByHeader(ws,H,rowPole,'Coordinate (Lat) NEW',p.coord.lat);
          setByHeader(ws,H,rowPole,'Coordinate (Long) NEW',p.coord.lon);
          setByHeader(ws,H,rowPole,'Pole Provider (New)','LN (Existing)');
          setByHeader(ws,H,rowPole,'Pole Type','Pole 7/250');
          setByHeader(ws,H,rowPole,'LINE',line);
          setByHeader(ws,H,rowPole,'FAT ID/NETWORK ID',net);

          rowPole++;
        });

      XLSX.writeFile(tplWB,'MASTER_POP_UP_RESULT.xlsx');
    };

    tplReader.readAsBinaryString(tpl);
  };

  dbReader.readAsBinaryString(db);
}
</script>

</body>
</html>
