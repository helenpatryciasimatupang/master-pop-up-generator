<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Master Pop Up Generator</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input { display: block; margin: 6px 0; padding: 6px; width: 280px; }
    button { margin-top: 10px; padding: 10px 20px; }
    .note { font-size: 12px; opacity: .8; margin-top: 10px; }
  </style>
</head>
<body>

<h2>Master Pop Up Generator</h2>

<input type="file" id="file" accept=".xlsx">

<h3>Input Area</h3>
<input id="area" placeholder="Nama Area">
<input id="district" placeholder="District">
<input id="subdistrict" placeholder="Sub District">
<input id="postcode" placeholder="Post Code">
<input id="fdt" placeholder="FDT Code">
<input id="idarea" placeholder="ID Area">

<button onclick="generate()">Generate Master Pop Up</button>
<div class="note">Clamp Hook Lat/Lon akan diambil dari baris DB yang FolderPath-nya /HOOK/{ID} lalu pakai kolom X & Y.</div>

<script>
// ===== UTIL =====
function normalize(v) {
  return String(v ?? '').trim().toUpperCase();
}

function toNum(v) {
  if (v === null || v === undefined || v === '') return NaN;
  const n = Number(String(v).trim());
  return Number.isFinite(n) ? n : NaN;
}

// Latitude = abs <= 90
function getLatLon(x, y) {
  const X = toNum(x), Y = toNum(y);
  if (!Number.isFinite(X) || !Number.isFinite(Y)) return { lat: '-', lon: '-' };

  if (Math.abs(X) <= 90 && Math.abs(Y) > 90) return { lat: X, lon: Y };
  if (Math.abs(Y) <= 90 && Math.abs(X) > 90) return { lat: Y, lon: X };
  return { lat: X, lon: Y };
}

// Ambil ID HOOK dari FolderPath setelah "/HOOK/"
function hookIdFromFolderPath(folderPath) {
  const fp = String(folderPath || '');
  const up = fp.toUpperCase();

  const idx = up.indexOf('/HOOK/');
  if (idx === -1) return '';

  // ambil substring setelah "/HOOK/"
  let rest = fp.slice(idx + 6);

  // ambil segmen pertama sebelum "/" (kalau ada subfolder)
  rest = rest.split('/')[0];

  // buang ekstensi file (contoh: 13R.KML)
  rest = rest.replace(/\.[A-Z0-9]+$/i, '');

  // buang spasi & karakter aneh, ambil token alnum paling depan
  // contoh "13R (HOOK)" -> "13R"
  const m = rest.toUpperCase().match(/[A-Z0-9]+/);
  return m ? m[0] : '';
}

function getArea() {
  return {
    area: document.getElementById('area').value,
    district: document.getElementById('district').value,
    subdistrict: document.getElementById('subdistrict').value,
    postcode: document.getElementById('postcode').value,
    fdt: document.getElementById('fdt').value,
    idarea: document.getElementById('idarea').value
  };
}

// ===== MAIN =====
function generate() {
  const file = document.getElementById('file').files[0];
  if (!file) return alert('Upload DATA BASE.xlsx');

  const reader = new FileReader();
  reader.onload = (e) => {
    const wb = XLSX.read(e.target.result, { type: 'binary' });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet);

    const area = getArea();
    const output = [];

    // ===== BUILD HOOK MAP FROM FOLDERPATH =====
    // hookMap["13R"] = {lat, lon} dari kolom X/Y baris HOOK 13R
    const hookMap = {};
    rows.forEach(r => {
      if (!r.FolderPath) return;
      if (String(r.FolderPath).toUpperCase().indexOf('/HOOK/') === -1) return;

      const hid = hookIdFromFolderPath(r.FolderPath);
      if (!hid) return;

      const coord = getLatLon(r.X, r.Y);
      // simpan pertama yang valid (kalau ada duplikat)
      if (!hookMap[hid] && coord.lat !== '-' && coord.lon !== '-') {
        hookMap[hid] = coord;
      }
    });

    // ===== POLE =====
    const poles = rows.filter(r => r.FolderPath && String(r.FolderPath).includes('/POLE/'));

    // ===== HOME / HOME-BIZ =====
    rows.forEach(r => {
      if (!r.FolderPath) return;
      if (!String(r.FolderPath).includes('/HOME') && !String(r.FolderPath).includes('/HOME-BIZ')) return;

      const house = r.Name || '-';

      let block = '-';
      let streetNum = house;
      if (/^[A-Za-z]\d+/.test(house)) {
        block = house[0];
        streetNum = house.slice(1);
      }

      const homeCoord = getLatLon(r.X, r.Y);

      const pole = poles.find(p => p.FAT === r.FAT);
      const poleCoord = pole ? getLatLon(pole.X, pole.Y) : { lat: '-', lon: '-' };

      // ===== CLAMP HOOK: ambil dari hookMap berdasarkan Clamp_Hook_ID (CLAIM_HOOK) =====
      const clampId = normalize(r.CLAIM_HOOK);     // contoh: 13R
      const hookCoord = hookMap[clampId] || { lat: '-', lon: '-' };

      output.push({
        HOMEPASS_ID: '-',
        CLUSTER_NAME: area.area,
        PREFIX_ADDRESS: 'JL.',
        STREET_NAME: r.JALAN || '-',
        HOUSE_NUMBER: house,
        BLOCK: block,
        STREET_NUMBER: streetNum,
        FLOOR: '-', RT: '-', RW: '-',
        DISTRICT: area.district,
        SUB_DISTRICT: area.subdistrict,
        POST_CODE: area.postcode,
        FDT_CODE: area.fdt,
        FAT_CODE: r.FAT || '-',
        BUILDING_LATITUDE: homeCoord.lat,
        BUILDING_LONGITUDE: homeCoord.lon,
        ADDRESS_POLE_FAT: '-',
        OV_UG: 'O',
        HOUSE_COMMENT_: 'NEED SURVEY',
        BUILDING_NAME: '-', TOWER: '-', APTN: '-', FIBER_NODE__HFC_: '-',
        ID_AREA: area.idarea,
        Clamp_Hook_ID: r.CLAIM_HOOK || '-',
        DEPLOYMENT_TYPE: 'FAT EXT',
        NEED_SURVEY: 'YES',
        Pole_ID_New: pole ? pole.Name : '-',
        Coordinate_Lat_NEW: poleCoord.lat,
        Coordinate_Long_NEW: poleCoord.lon,
        Pole_Provider_New: 'LN (Existing)',
        Pole_Type: 'Pole 7/250',
        LINE: '',
        FAT_ID_NETWORK_ID: pole ? pole.FAT : '-',
        Clamp_Hook_LATITUDE: hookCoord.lat,
        Clamp_Hook_LONGITUDE: hookCoord.lon
      });
    });

    const ws = XLSX.utils.json_to_sheet(output);
    const wbOut = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wbOut, ws, 'MASTER_POP_UP');
    XLSX.writeFile(wbOut, 'MASTER_POP_UP.xlsx');

    // Debug kecil (kalau masih kosong, ini bantu)
    // alert(`HOOK terdeteksi: ${Object.keys(hookMap).length} | Row output: ${output.length}`);
  };

  reader.readAsBinaryString(file);
}
</script>

</body>
</html>
