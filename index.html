<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Master Pop Up Generator (Template Based)</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input { display: block; margin: 6px 0; padding: 6px; width: 320px; }
    button { margin-top: 12px; padding: 10px 22px; }
  </style>
</head>
<body>

<h2>Master Pop Up Generator</h2>

<input type="file" id="file" accept=".xlsx">

<h3>Input Area</h3>
<input id="area" placeholder="Nama Area">
<input id="district" placeholder="District">
<input id="subdistrict" placeholder="Sub District">
<input id="postcode" placeholder="Post Code">
<input id="fdt" placeholder="FDT Code">
<input id="idarea" placeholder="ID Area">

<button onclick="generate()">Generate Master Pop Up</button>

<script>
async function generate() {
  const dbFile = document.getElementById('file').files[0];
  if (!dbFile) {
    alert('Upload DATA BASE.xlsx');
    return;
  }

  // ===============================
  // 1. READ DATABASE
  // ===============================
  const dbReader = new FileReader();
  dbReader.onload = async (e) => {
    const wbDB = XLSX.read(e.target.result, { type: 'binary' });
    const dbSheet = wbDB.Sheets[wbDB.SheetNames[0]];
    const dbRows = XLSX.utils.sheet_to_json(dbSheet);

    // ===============================
    // 2. LOAD TEMPLATE MASTER POP UP
    // ===============================
    const tplResp = await fetch('New_Master_Pop_UP.xlsx');
    const tplBuf = await tplResp.arrayBuffer();
    const wbTpl = XLSX.read(tplBuf, { type: 'array' });
    const ws = wbTpl.Sheets['MASTER_POP_UP'] || wbTpl.Sheets[wbTpl.SheetNames[0]];

    // ===============================
    // 3. MAP HEADER â†’ COLUMN LETTER
    // ===============================
    const headerMap = {};
    Object.keys(ws)
      .filter(k => k.endsWith('1'))
      .forEach(k => {
        const header = ws[k].v;
        const col = k.replace('1', '');
        headerMap[header] = col;
      });

    // ===============================
    // 4. PREPARE LOOKUP
    // ===============================
    const poles = dbRows.filter(r => r.FolderPath?.includes('/POLE/'));
    const hooks = dbRows.filter(r => r.FolderPath?.includes('/HOOK/'));

    // ===============================
    // 5. FILL TEMPLATE ROW BY ROW
    // ===============================
    let rowIndex = 2;

    dbRows.forEach(r => {
      if (!r.FolderPath) return;
      if (!r.FolderPath.includes('/HOME') && !r.FolderPath.includes('/HOME-BIZ')) return;

      const pole = poles.find(p => p.FAT === r.FAT);
      const hook = hooks.find(h => h.Name === r.CLAIM_HOOK);

      // ðŸ”’ KUNCI: LAT = X, LON = Y
      ws[headerMap['HOMEPASS_ID'] + rowIndex] = { v: '-' };
      ws[headerMap['CLUSTER_NAME'] + rowIndex] = { v: document.getElementById('area').value };
      ws[headerMap['PREFIX_ADDRESS'] + rowIndex] = { v: 'JL.' };
      ws[headerMap['STREET_NAME'] + rowIndex] = { v: r.JALAN || '-' };
      ws[headerMap['HOUSE_NUMBER'] + rowIndex] = { v: r.Name || '-' };

      ws[headerMap['DISTRICT'] + rowIndex] = { v: document.getElementById('district').value };
      ws[headerMap['SUB_DISTRICT'] + rowIndex] = { v: document.getElementById('subdistrict').value };
      ws[headerMap['POST_CODE'] + rowIndex] = { v: document.getElementById('postcode').value };
      ws[headerMap['FDT_CODE'] + rowIndex] = { v: document.getElementById('fdt').value };

      ws[headerMap['FAT_CODE'] + rowIndex] = { v: r.FAT || '-' };

      // ðŸ”¥ INI POIN UTAMA
      ws[headerMap['BUILDING_LATITUDE'] + rowIndex] = { v: r.X };
      ws[headerMap['BUILDING_LONGITUDE'] + rowIndex] = { v: r.Y };

      ws[headerMap['OV_UG'] + rowIndex] = { v: 'O' };
      ws[headerMap['HOUSE_COMMENT_'] + rowIndex] = { v: 'NEED SURVEY' };
      ws[headerMap['ID_AREA'] + rowIndex] = { v: document.getElementById('idarea').value };

      ws[headerMap['Clamp_Hook_ID'] + rowIndex] = { v: r.CLAIM_HOOK || '-' };
      ws[headerMap['DEPLOYMENT_TYPE'] + rowIndex] = { v: 'FAT EXT' };
      ws[headerMap['NEED_SURVEY'] + rowIndex] = { v: 'YES' };

      if (pole) {
        ws[headerMap['Pole ID (New)'] + rowIndex] = { v: pole.Name };
        ws[headerMap['Coordinate (Lat) NEW'] + rowIndex] = { v: pole.X };
        ws[headerMap['Coordinate (Long) NEW'] + rowIndex] = { v: pole.Y };
        ws[headerMap['FAT ID/NETWORK ID'] + rowIndex] = { v: pole.FAT };
      }

      if (hook) {
        ws[headerMap['Clamp_Hook_LATITUDE'] + rowIndex] = { v: hook.X };
        ws[headerMap['Clamp_Hook_LONGITUDE'] + rowIndex] = { v: hook.Y };
      }

      rowIndex++;
    });

    // ===============================
    // 6. EXPORT
    // ===============================
    XLSX.writeFile(wbTpl, 'MASTER_POP_UP.xlsx');
  };

  dbReader.readAsBinaryString(dbFile);
}
</script>

</body>
</html>
